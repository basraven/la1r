---
# Source: https://www.digitalocean.com/community/tutorials/how-to-set-up-an-openvpn-server-on-ubuntu-16-04
# Source: https://www.howtoforge.com/tutorial/how-to-install-openvpn-on-centos-7/
- name: Create Server Certificates / Install needed tools
  become: yes
  package:
    name: "{{ item }}"
    state: present
  with_items: 
    - easy-rsa
    # - gzip

- name: Create Server Certificates / Init PKI and Build CA
  become: true
  shell: |
    export EASYRSA_BATCH=1 # non-interactive mode
    cp /usr/share/easy-rsa/easyrsa ./easyrsa
    chmod +x ./easyrsa
    ./easyrsa init-pki
    ./easyrsa build-ca nopass
  args:
    chdir: "{{ openvpn_ca_dir }}"
    executable: /bin/bash

- name: Create Server Certificates / Generate Diffie-Hellman keys (might take a while)
  become: true
  shell: './easyrsa gen-dh'
  async: 2000
  poll: 10
  args:
    chdir: "{{openvpn_ca_dir}}"
    executable: /bin/bash

- name: Create Server Certificates / openvpn gen ta.key
  become: true
  shell: |
    openvpn --genkey secret pki/ta.key
  args:
    chdir: "{{ openvpn_ca_dir }}"
    executable: /bin/bash

- name: Create Server Certificates / easyrsa serverbuild + crl
  become: true
  shell: |
    export EASYRSA_BATCH=1 # non-interactive mode
    ./easyrsa build-server-full "{{openvpn_server_url}}" nopass
    ./easyrsa gen-crl
  args:
    chdir: "{{ openvpn_ca_dir }}"
    executable: /bin/bash

- name: Create Server Certificates / establish openvpn.base.conf.j2 template in {{ openvpn_client_configs_dir }}/{{ openvpn_user }}.ovpn"
  become: yes
  template:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
  with_items:
      - { src: server.conf.j2, dest:  "/etc/openvpn/server.conf" }

# KEEP: to explore tuning opptys
# - name: Create Server Certificates / Copy the example config from openvpn
#   become: true
#   shell: |
#     gunzip -c /usr/share/doc/openvpn/examples/sample-config-files/server.conf.gz | \
#     tee /etc/openvpn/server.conf


- include_tasks: networking.yml